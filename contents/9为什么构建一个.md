### 为什么构建一个？

让我们把刚刚学到的知识放到一个更广阔的视角中来看。为什么要构建一个虚拟机来实现一种编程语言呢？我必须承认，这是我长久以来一直带着的问题。即使在我构建了几个小型虚拟机，并且阅读了更大规模虚拟机的源代码之后，我仍然在问自己：为什么？

当我们实现一种编程语言时，我们希望它是通用的。它应该能够执行所有可能的程序，而不仅仅是——举个例子——我们内置到其中的功能。我们追求的是通用计算，而计算机为此提供了一个坚实的模型。

如果我们根据这个模型构建一种编程语言，那么这种语言将拥有与计算机相同的计算能力。这也是执行程序最快的方式之一。

但是，如果像计算机那样执行程序是最佳且最快的方法，为什么不直接让计算机来执行这些程序呢？原因在于可移植性。我们可以为我们的编程语言编写一个编译器，这样就可以在计算机上原生地执行被翻译的程序。这些程序将会非常快。但是，我们也必须为每种想要运行我们程序的计算机架构编写一个新的编译器。这是一项庞大的工作。相反，我们可以将我们的程序翻译成虚拟机的指令。而虚拟机本身可以在与其实现语言一样多的架构上运行。以Go编程语言为例，它的可移植性非常好。

还有另一个理由支持使用虚拟机来实现编程语言，我认为这是最吸引人的一点：虚拟机是领域特定的。这就是它们与非虚拟对手的区别所在。计算机为我们所有的计算需求提供了一种通用解决方案，并且明显不是领域特定的。这很好，这正是我们需要从一台可以运行各种程序的计算机中得到的。但如果我们不需要一台机器如此通用呢？如果我们只需要计算机提供给程序员功能的一个子集呢？作为程序员我们知道，没有任何功能是没有代价的。增加的复杂性和性能下降只是我们通常为它们支付的两种代价。如今的计算机有很多功能。x86-64系列的CPU支持900到4000条指令，具体取决于你如何计数。这包括至少六种不同的方式来对两个操作数进行位异或运算。这很方便，也是计算机如此多功能的原因。但这不是免费的。多功能性有其成本，就像其他任何功能一样。回想一下我们小型虚拟机中的switch语句，并花点时间思考一下添加3997个更多的case分支会对性能产生什么影响。如果你不确定它是否会更慢，请问自己维护这段代码或为这个虚拟机编程有多容易。好消息是我们可以扭转这种情况。如果我们去掉不需要的功能，我们可以变得更快。更少的复杂性，更少的维护，更少的质量。这就是虚拟机发挥作用的地方。

虚拟机就像是定制的计算机。它有定制的部件和定制的机器语言。它是针对单一编程语言调优的。所有不需要的功能都被剥离掉，剩下的就是高度专业化的部分。由于你不必像通用计算机那样通用，你可以专注于使这台高度专业化和定制的机器尽可能好、尽可能快地工作。这种专业化、领域特定性，就像去掉不必要的质量一样重要。

为什么这一点如此重要，在我们查看虚拟机执行的指令时会变得更加清晰，这是我们之前一直避免讨论的内容。还记得我们给小型虚拟机输入了什么吗？再来看一遍：

```javascript
let program = [
    PUSH, 3,
    PUSH, 4,
    ADD,
    PUSH, 5,
    MINUS
];

virtualMachine(program);
```

现在，这是什么？什么是 PUSH？什么是 ADD？什么是 MINUS？这是它们的定义：

```javascript
const PUSH = 'PUSH';
const ADD = 'ADD';
const MINUS = 'MINUS';
```

PUSH、 ADD 和 MINUS 只是引用字符串的常量。这里没有任何神奇之处。真是令人失望！不过，这个发现的一线希望是，这些定义就像虚拟机的其他部分一样，只是为了演示而设计得非常简单。它们并没有回答这里悬而未决的一个更大、更有趣的问题：虚拟机到底执行的是什么？

|[⬅ 什么是虚拟机](./8什么是虚拟机.md)|[字节码 ➡](./10字节码.md)|
| --- | --- |
